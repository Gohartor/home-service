<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØµÙØ­Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; direction: rtl; margin: 40px; }
        .box { max-width: 400px; margin: auto; border: 1px solid #ddd; border-radius: 8px; padding: 24px; background: #fafbfc;}
        label { display: block; margin-top: 16px; font-weight: bold;}
        .captcha-img { margin: 16px 0 8px 0; border-radius: 4px; }
        #timer { font-family: monospace; margin-top: 10px; color: #d30; font-size: 1.3em;}
        #msg { margin: 16px 0; color: #084; font-weight: bold;}
        button, input { font-size: 1em; padding: 8px; margin-top: 6px;}
        button:disabled { background: #eee; color: #aaa;}
        .refresh-btn { margin-right: 10px; font-size: 0.9em;}
        input[type="text"] { width: 100%;}
    </style>
</head>
<body>
<div class="box">
    <h2>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙØ§Ø±Ø´</h2>
    <div id="msg"></div>
    <form id="payForm" autocomplete="off" onsubmit="return false;">
        <div id="captcha-section">
            <label for="captchaInput">Ú©Ù¾Ú†Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</label>
            <img id="captchaImage" class="captcha-img" src="" alt="Ú©Ù¾Ú†Ø§" height="50">
            <button type="button" class="refresh-btn" onclick="refreshCaptcha();">ğŸ”„ Ú©Ù¾Ú†Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</button>
            <input type="text" id="captchaInput" required placeholder="Ú©Ø¯ Ø¯Ø§Ø®Ù„ ØªØµÙˆÛŒØ±">
        </div>
        <label for="cardNumber">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª</label>
        <input type="text" id="cardNumber" maxlength="16" required placeholder="Ù…Ø«Ù„Ø§Ù‹ Û¶Û°Û³Û·Û¹Û¹Û·ÛµÛ´Û´Û²Û±Û°Û°Û±Û°">
        <label for="cvv2">CVV2</label>
        <input type="text" id="cvv2" maxlength="4" required placeholder="Ù…Ø«Ù„Ø§Ù‹ ÛµÛ²Û³">
        <div id="timer">10:00</div>
        <button id="payBtn" type="submit">Ù¾Ø±Ø¯Ø§Ø®Øª</button>
    </form>
</div>

<script>
    const orderId = 2;

    let paymentToken = null;
    let expireAt = Date.now() + 600000;
    let timerInterval = null;

    async function fetchInit() {
        console.log("fetchInit started");

        document.getElementById('msg').innerText = '';
        document.getElementById('msg').style.color = '#084';
        document.getElementById('payBtn').disabled = true;
        try {
            const resp = await fetch(`/api/payments/init/${orderId}`);
            if (!resp.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª');
            const data = await resp.json();
            paymentToken = data.token;

            console.log('captchaImageBase64:', data.captchaImageBase64);
            document.getElementById('captchaImage').src = "data:image/png;base64," + data.captchaImageBase64;

            expireAt = Date.now() + 10 * 60 * 1000;
            startTimer();
            document.getElementById('payBtn').disabled = false;
        } catch (e) {
            document.getElementById('msg').innerText = e.message || 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡!';
        }
        console.log("API response received:", data);
    }

    function refreshCaptcha() {
        fetchInit();
        document.getElementById('captchaInput').value = '';
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            let seconds = Math.floor((expireAt - Date.now()) / 1000);
            if (seconds <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = 'Û°Û°:Û°Û°';
                document.getElementById('payBtn').disabled = true;
                document.getElementById('msg').style.color = '#d30';
                document.getElementById('msg').innerText = 'Ù…Ù‡Ù„Øª Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙ…Ø§Ù… Ø´Ø¯.';
            } else {
                const m = String(Math.floor(seconds / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }
        }, 1000);
    }

    document.getElementById('payForm').onsubmit = async function() {
        document.getElementById('payBtn').disabled = true;
        document.getElementById('msg').innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
        document.getElementById('msg').style.color = '#555';
        const payReq = {
            token: paymentToken,
            captcha: document.getElementById('captchaInput').value,
            cardNumber: document.getElementById('cardNumber').value,
            cvv2: document.getElementById('cvv2').value
        };
        try {
            const resp = await fetch('/api/payments/pay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payReq)
            });
            const resData = await resp.json();
            if(resp.ok) {
                document.getElementById('msg').innerText = resData.message || 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!';
                document.getElementById('msg').style.color = '#084';
                document.getElementById('payBtn').disabled = true;
                clearInterval(timerInterval);
            } else {
                document.getElementById('msg').innerText = resData.message || 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!';
                document.getElementById('msg').style.color = '#d30';
                document.getElementById('payBtn').disabled = false;
                if(resData.captchaInvalid || resData.code === "EXPIRED") refreshCaptcha();
            }
        } catch(e){
            document.getElementById('msg').innerText = 'Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±!';
            document.getElementById('msg').style.color = '#d30';
            document.getElementById('payBtn').disabled = false;
        }
    };

    window.onload = fetchInit;
</script>
</body>
</html>
